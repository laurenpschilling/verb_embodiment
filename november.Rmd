---
title: "bucld"
output: html_document
date: "2025-06-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(broom)
library(broom.mixed)
library(car)
library(childesr)
library(cluster)
library(corrr)
library(dplyr)
library(EFAtools)
library(factoextra)
library(GGally)
library(ggeffects)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(GPArotation)
library(gridExtra)
library(haven)
library(htmltools)
library(kableExtra)
library(knitr)
library(lme4)
library(lmerTest)
library(mirt)
library(plotly)
library(pROC)
library(psych)
library(purrr)
library(Rtsne)
library(scatterplot3d)
library(sjPlot)
library(stargazer)
library(tidyverse)
library(wordbankr)
```

# Load data

## Load `verbs_items` data

```{r}
verbs_items <- read.csv('~/documents/research/verb_embodiment/verb_items.csv') %>% 
  select(!sidhu) %>% 
  mutate(embod_z = scale(embod)[,1],
         concrete_z = scale(concrete)[,1],
         image_z = scale(image)[,1],
         item_id = paste0("item_", item_id)
)
```

## Load `mb_cdi_by_child` data

```{r}
by_child <- read.csv('~/documents/research/norms/mb_cdi_by_child.csv') %>% 
  mutate(age_c = (age - 16)) %>% 
  group_by(child_id) %>%
  slice(1) %>%
  ungroup()

prod_size <- read.csv('~/documents/research/norms/mb_cdi_by_child.csv') %>% 
  select(child_id, production) %>% 
  rename(prod_size = production) %>% 
  mutate(prod_size_z = scale(prod_size)[,1])

by_child <- by_child %>% 
  left_join(prod_size)

n_distinct(by_child$child_id)
```

## PREP: Load & clean Wordbank data

```{r}
english_ws_admins <- get_administration_data("English (American)", "WS")

child_id_match <- english_ws_admins %>% 
  select(child_id, data_id)

by_child <- by_child %>% 
  left_join(child_id_match) %>% 
  group_by(child_id) %>% 
  slice(1) %>% 
  ungroup()

list <- by_child$data_id

verbs_id <- unique(verbs_items$item_id)

verbs_long_data <- get_instrument_data("English (American)", "WS") %>% 
  filter(data_id %in% list) %>% 
  filter(item_id %in% verbs_id) %>% 
  mutate(produces = ifelse(value == "produces", 1, 0)) %>% 
  select(-value, -understands) %>% 
  left_join(child_id_match) %>% 
  select(item_id, child_id, produces) %>% 
  mutate(produces = replace(produces, is.na(produces), 0))

write_csv(verbs_long_data, "~/documents/research/verb_embodiment/verbs_long_data.csv")

rm(child_id_match, english_ws_admins, list, verbs_id)
```

## Load `verbs_long_data` & create `verbs_wide_data`

```{r}
verbs_long_data <- read.csv("~/documents/research/verb_embodiment/verbs_long_data.csv")

verbs_wide_data <- verbs_long_data %>%
  pivot_wider(
    names_from = item_id,
    values_from = produces
  ) 
```

# 8 displays

## Child stats

Mean Age: 23.4, SD Age: 4.31

```{r}
by_child %>% 
  summarise(mean_age = mean(age),
            sd_age = sd(age))

by_child %>% 
  group_by(sex) %>% 
  summarise(n = n())

demo <- by_child %>%
  group_by(caregiver_education) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(caregiver_education = recode(caregiver_education,
    "Primary" = "Less than secondary school",
    "Some Secondary" = "Some secondary school",
    "Secondary" = "Completed secondary school",
    "Some College" = "Some college/university",
    "College" = "Completed college/university",
    "Some Graduate" = "Some graduate/prof. school",
    "Graduate" = "Completed graduate/prof. school")) %>%
    mutate(percent = round(percent, 1),
           n = format(n, big.mark = ","))

demo <- demo %>%
  mutate(
    caregiver_education = factor(
      caregiver_education,
      levels = c(
        "Less than secondary school", 
        "Some secondary school",
        "Completed secondary school",
        "Some college/university",
        "Completed college/university",
        "Some graduate/prof. school",
        "Completed graduate/prof. school"
      )
    )
  ) %>%
  arrange(caregiver_education)

demo %>% 
  rename(`Caregiver Education` = caregiver_education,
         `N` = n,
         `%` = percent) %>%
  kable(
    caption = "<span style='font-family: Times New Roman;'>Caregiver Education Level (N = 5899)</span>",
    col.names = c("Caregiver Education", "N", "%"),
    align = c("l", "r", "r"),
    booktabs = TRUE,
    format = "html"
  ) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>%
  row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:3, extra_css = "font-family: Times New Roman;")

rm(demo)

by_child$older <- ifelse(by_child$age_c >= mean(by_child$age_c), 1, 0)
```

## Verb stats

```{r}
verb_stats <- verbs_long_data %>%
  left_join(verbs_items) %>% 
  group_by(item_id) %>% 
  summarise(proportion = round(mean(produces, na.rm = TRUE), 2)) %>%
  select(item_id, proportion) %>%
  arrange(desc(proportion))
```

### Table of verb stats

```{r}
table <- verb_stats %>%
  kable(caption = "Descriptive Statistics for Verb Items", align = "lc") %>%
  kable_styling(full_width = FALSE, font_size = 12)

verb_stats_split <- split(verb_stats, (seq(nrow(verb_stats)) - 1) %/% 12)

max_rows <- max(sapply(verb_stats_split, nrow))

verb_stats_split_padded <- map(verb_stats_split, ~ {
  n_missing <- max_rows - nrow(.x)
  if (n_missing > 0) {
    bind_rows(.x, tibble(
      Item = rep(NA, n_missing),
      `Mean (SD)` = rep(NA, n_missing)
    ))
  } else {
    .x
  }
})

wide_table <- bind_cols(verb_stats_split_padded)

colnames(wide_table) <- rep(c("Item", "Proportion"), times = 12)

align_vector <- rep(c("l", "c"), times = 12)

kable(wide_table, caption = "<span style='font-family: Times New Roman;'>Proportion of Children Producing Each Verb</span>", align = align_vector) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>% 
   row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:8, extra_css = "font-family: Times New Roman;")

verb_means <- verbs_long_data %>%
  group_by(item_id) %>% 
  summarise(mean = round(mean(produces, na.rm = TRUE), 2)) %>% 
  select(item_id, mean)

verbs_items <- verbs_items %>% 
  left_join(verb_means)

rm(verb_stats, verb_stats_split, verb_stats_split_padded, wide_table, align_vector, max_rows, table, verb_means)
```

## Summarize word-level characteristics

Contains missing values

```{r}
sum_verb_props <- verbs_items %>%
  summarise(mean_embod = mean(embod),
            sd_embod = sd(embod),
            range_embod = paste(min(embod), max(embod), sep = "-"),
            mean_concrete = mean(concrete),
            sd_concrete = sd(concrete),
            range_concrete = paste(min(concrete), max(concrete), sep = "-"),
            mean_image = mean(image),
            sd_image = sd(image),
            range_embod = paste(min(image), max(image), sep = "-"))
```

### Visualize `embod`

```{r}
verbs_items %>% 
  ggplot(aes(x = embod)) +
  geom_histogram(bins = 50, color = "black", fill = "white") +
  xlim(c(0, 5)) +
  scale_x_continuous(n.breaks = 8) +
  labs(title = "Verb Embodiment (Scale of 1-7)",
       x = "Verb Embodiment",
       y = "Count of Words",
       caption = "N Verbs = 103") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"))
```

## Item correlation matrix

```{r}
item_corr <- verbs_wide_data %>% 
  select(starts_with("item")) %>% 
  correlate()

lower <- lowerCor(item_corr)

lower_df <- round(lower, 2) %>%
  as.data.frame() %>%
  rownames_to_column(var = " ")

rm(item_corr, lower)
```

## Calculate average verb scores per child

```{r 13}
mean_verb_score <- verbs_long_data %>% 
  group_by(child_id) %>% 
  summarise(mean_verb_score = mean(produces)) 

by_child <- by_child %>% 
  left_join(mean_verb_score)

rm(mean_verb_score)

verb_prod_size <- verbs_long_data %>% 
  group_by(child_id) %>% 
  summarise(verb_prod_size = sum(produces)) 

by_child <- by_child %>% 
  left_join(verb_prod_size)

rm(verb_prod_size)
```

### Calculate correlation between `mean_verb_score` and `age`
r = 0.67

```{r}
corr.test(by_child$mean_verb_score, by_child$age)
```

### Visualize average scores by child age

```{r}
by_child %>% 
    mutate(age_bin = paste0(floor(age / 2) * 2, "-", floor(age / 2) * 2 + 1)) %>%
  ggplot(aes(x = age_bin, y = mean_verb_score)) +
  geom_boxplot() +
  labs(title = "Proportion of MB-CDI Verbs A Child Produced by Child Age",
       x = "Age in Months",
       y = "Proportion of MB-CDI Verbs Produced",
       caption = "N Children = 5899; N Verbs = 103") +
    theme_minimal() +
theme(text = element_text(family = "Avenir"), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12))
```

### Visualize average scores per child

```{r}
by_child %>% 
  ggplot(aes(x = mean_verb_score)) +
  geom_histogram(bins = 25, color = "black", fill = "white") +
  xlim(c(0, 1)) +
  scale_x_continuous(n.breaks = 10) +
  labs(title = "Proportion of MB-CDI Verbs Produced by Children",
       x = "Proportion of Verbs Produced",
       y = "Count of Children",
       caption = "N Children = 5899; N Verbs = 103") +
  theme_minimal() +
  theme(text = element_text(family = "Avenir"))
```

## Calculate proportion of children producing each verb

```{r}
verb_prop <- verbs_long_data %>%
  left_join(verbs_items) %>% 
  group_by(word) %>% 
  summarise(proportion = round(mean(produces, na.rm = TRUE), 2)) %>%
  select(word, proportion)

verbs_items <- verbs_items %>% 
  left_join(verb_prop)

rm(verb_prop)
```

### Table of proportion of children producing each verb

```{r}
verb_stats <- verbs_items %>% 
  rename(Proportion = proportion, Word = word) %>% 
  arrange(desc(Proportion)) %>% 
  select(Word, Proportion)

table <- verb_stats %>%
  kable(caption = "Descriptive Statistics for Verb Items", align = "lc") %>%
  kable_styling(full_width = FALSE, font_size = 12)

verb_stats_split <- split(verb_stats, (seq(nrow(verb_stats)) - 1) %/% 12)

max_rows <- max(sapply(verb_stats_split, nrow))

verb_stats_split_padded <- map(verb_stats_split, ~ {
  n_missing <- max_rows - nrow(.x)
  if (n_missing > 0) {
    bind_rows(.x, tibble(
      Item = rep(NA, n_missing),
      `Mean (SD)` = rep(NA, n_missing)
    ))
  } else {
    .x
  }
})

wide_table <- bind_cols(verb_stats_split_padded)

colnames(wide_table) <- rep(c("Item", "Proportion"), length.out = 20)

align_vector <- rep(c("l", "c"), times = 1)

kable(wide_table, caption = "<span style='font-family: Times New Roman;'>Proportion of Children Producing Each Verb</span>", align = align_vector) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>% 
   row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:20, extra_css = "font-family: Times New Roman;")
```

### Visualize average scores per verb by embodiment

```{r 14}
verbs_items %>%  
  ggplot(aes(x = embod_z, y = mean, label = word)) +
  geom_point(size = 1, alpha = 0.25) +
  geom_text_repel(family = "Times New Roman", size = 4, box.padding = 0.2, max.overlaps = 47) +
  ylim(c(0, 1)) +
  labs(title = "Proportion of Children Producing Each Verb by Embodiment",
       x = "Verb Embodiment (Z)",
       y = "Proportion of Children",
       caption = "N Children = 5899; N Verbs = 47") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"))
```

### Visualize average scores per verb by embodiment unstandardized

```{r 14}
verbs_items %>%  
  ggplot(aes(x = embod, y = mean, label = word)) +
  geom_point(size = 1, alpha = 0.25) +
  geom_text_repel(family = "Times New Roman", size = 4, box.padding = 0.2, max.overlaps = 47) +
  ylim(c(0, 1)) +
  labs(title = "Proportion of Children Producing Each Verb by Embodiment",
       x = "Verb Embodiment",
       y = "Proportion of Children",
       caption = "N Children = 5899; N Verbs = 47") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"))
```

### Calculate correlation between `mean_verb_score` and `embod_z`

```{r}
test <- corr.test(verbs_items$mean, verbs_items$embod_z)

test$p
```

## Estimate reliability

Alpha = 0.993

```{r}
verbs_wide_data <- as.data.frame(verbs_wide_data)

psychobj <- verbs_wide_data %>%
  select(starts_with("item")) %>% 
  psych::alpha()

thealpha <- psychobj$total$raw_alpha
```

## Estimate Item-Test Correlations

Create a tibble of the ITCs and plot the data. Identify possible items to examine further. 

```{r}
itcor <- psychobj$item.stats %>% 
  select(raw.r)

itcor_df <- tibble(item = 1:103,
                   cor = psychobj$item.stats$raw.r,
                   word = itcor$item)

itcor_df <- itcor_df %>% 
  cbind(verbs_items$item_id, verbs_items$item)

ggplot(itcor_df, aes(x = item, y = cor, label = verbs_items$item)) +
  geom_point(size = 1, alpha = 0.25) +
  geom_line(alpha = 0.25) +
  geom_text_repel(family = "Times New Roman", size = 4, box.padding = 0.15, max.overlaps = 103) +
  ylim(c(0, 1)) +
  labs(title = "Item-Test Correlations by Verb",
    x = "Verb",
    y = "Item-Test Correlation",
    caption = "N Verbs = 47") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_x_continuous(n.breaks = 100)
  
rm(align_vector, itcor, itcor_df, max_rows, psychobj, table, test, thealpha, verb_stats_split, verb_stats_split_padded, wide_table)
```

# Multidimensionality 

## Scree plot

```{r}
pca_results <- verbs_wide_data %>%
  select(starts_with("item")) %>% 
  prcomp(scale. = TRUE)

fviz_eig(pca_results, addlabels = TRUE, ylim = c(0, 60)) +
  theme(text = element_text(family = "Times New Roman"))
```

## Extract loadings

```{r}
loadings <- as.data.frame(pca_results$rotation)

loadings <- rownames_to_column(loadings, var = "item_id")
```

# Item Response Theory analyses

## 1-Parameter Logistic (1PL) Model: The Rasch Model

Fit a 1PL model using `ltm` package. The `mirt()` function uses the Rasch formulation of the 1PL model, in which the item information parameters are fixed at 1. Extract the coefficients from the model, and create a `rasch_pars` tibble. Use `as.data.frame()` to convert the tibble to a dataframe. List the items by difficulty.

```{r 22}
mod_1pl <- verbs_wide_data %>% 
  select(starts_with("item")) %>% 
  mirt(1, itemtype = "Rasch", verbose = FALSE) 

one_pl_pars <- coef(mod_1pl, IRTpars = TRUE, simplify = TRUE)$items %>% 
  as_tibble()

one_pl_pars <- as.data.frame(coef(mod_1pl, IRTpars = TRUE, simplify = TRUE)$items) %>% 
  arrange(-b)

print(one_pl_pars)
```

### Visualize Item Characteristic Curves

```{r 23}
plot(mod_1pl, type = "trace")
```

## 2-Parameter Logistic (2PL) Model 

Add `item` to `data`. Fit the 2PL model using the `ltm` package.

```{r 25}
names <- verbs_items$word

wide_data_2pl <- verbs_wide_data %>% 
  select(starts_with("item"))

colnames(wide_data_2pl) <- names

mod_2pl <- wide_data_2pl %>%
  mirt(1, type = "2PL", verbose = FALSE)
```

### Compare the model fits

See if fit of 2PL is better than 1PL. 2PL will generally fit better than 1PL when samples are large. Chi-square(46) = 2,425.344 (p < 0.001)

```{r 26}
mod_tab <- anova(mod_1pl, mod_2pl)

mod_tab <- mod_tab %>%
  mutate(
    AIC = round(AIC, 1),
    BIC = round(BIC, 1),
    'Log-Likelihood' = round(logLik, 1),
    'Chi-Square' = round(X2, 2),
    'p-value' = ifelse(p < .001, "< .001", sprintf("%.3f", p))) %>% 
  select(df, AIC, BIC, "Log-Likelihood", "Chi-Square", "p-value")

mod_tab %>%
  kable(
    caption = "<span style='font-family: Times New Roman;'>Model Comparison Between 1PL and 2PL IRT Models</span>",
    align = "lccccc",
    col.names = c("Model", "df", "AIC", "BIC", "Log-Likelihood", "Chi-square", "p")
  ) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>% 
   row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:7, extra_css = "font-family: Times New Roman;")
```

### Plot 2PL's Item Characteristic Curves

```{r 28}
plot(mod_2pl, type = "trace")
```

### Plot 2PL's Item Information Functions

```{r 33}
plot(mod_2pl, type = "infotrace")
```

### Plot 2PL's Conditional Standard Error of Measurement.

```{r}
plot(mod_2pl, type = "infoSE")
```

### Add 2PL coefficients to `verbs`

```{r 27}
two_pl_pars <- coef(mod_2pl, simplify = TRUE, IRTpars = TRUE)$items %>%  
  as_tibble()

two_pl_pars <- as.data.frame(coef(mod_2pl, simplify = TRUE, IRTpars = TRUE)$items) %>% 
  arrange(-b)

two_pl_pars$word <- rownames(two_pl_pars)

print(two_pl_pars)

verbs_items <- verbs_items %>% 
  left_join(two_pl_pars) %>% 
  select(-g, -u)
```

#### Visualize 2PL parameters

```{r}
two_pl <- verbs_items %>%
  select(word, a, b) %>% 
  mutate(a = round(a, 2),
         b = round(b, 2)) %>% 
  rename(Verb = word,
         'Information Parameter Estimates (i)' = a,
         'Difficulty Parameter Estimates (d)' = b) %>% 
  arrange('Difficulty Parameter Estimates (d)')
```

### Table of 2PL parameter estimates

```{r}
table <- two_pl %>%
  kable(caption = "Item Information and Difficulty Parameter Estimates Based on a 2PL Model", align = "lc") %>%
  kable_styling(full_width = FALSE, font_size = 12)

two_pl_split <- split(two_pl, (seq(nrow(two_pl)) - 1) %/% 12)

max_rows <- max(sapply(two_pl_split, nrow))

two_pl_split_padded <- map(two_pl_split, ~ {
  n_missing <- max_rows - nrow(.x)
  if (n_missing > 0) {
    bind_rows(.x, tibble(
      Item = rep(NA, n_missing)
    ))
  } else {
    .x
  }
})

wide_table <- bind_cols(two_pl_split_padded)

colnames(wide_table) <- rep(c("Item", "Information Parameter Estimates (i)", "Difficulty Parameter Estimates (d)"), times = 4)

align_vector <- rep(c("l", "c"), times = 12)

kable(wide_table, caption = "<span style='font-family: Times New Roman;'>Item Information & Difficulty Parameter Estimates Based on a 2PL Model</span>", align = align_vector) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>% 
   row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:12, extra_css = "font-family: Times New Roman;")

rm(verb_stats, verb_stats_split, verb_stats_split_padded)
```

### Add thetas to `by_child`

```{r}
verbs_wide_data <- verbs_wide_data %>%  
  mutate(theta_2pl = fscores(mod_2pl)[,]) %>% 
  select(child_id, theta_2pl, everything())

by_child <- by_child %>% 
  left_join(verbs_wide_data) %>%
  select(child_id, mean_verb_score, theta_2pl, age, age_c, older, caregiver_education, sex)
```

# Plot item map

```{r}
ggplot(verbs_items, aes(x = b, y = reorder(word, b))) +
  geom_point() +
  labs(title = "Item Map of Verbs", 
       x = "Verb Production Proficiency (Theta)", 
       y = "Item",
       caption = "N Verbs = 47 ") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"),
        axis.text.y = element_text(hjust = 1, size = 8))
```

## Visualize b by `embod`

```{r}
verbs_items %>%  
  ggplot(aes(x = embod_z, y = b, label = word)) +
  geom_point(size = 1, alpha = 0.25) +
  geom_smooth(method = 'lm', se = FALSE, color = "lightblue") +
  geom_text_repel(family = "Times New Roman", size = 4, box.padding = 0.2, max.overlaps = 47) +
  labs(title = expression("Verb Production Difficulty ("*italic(d)[v]*") by Embodiment"),
       x = "Embodiment (Z)",
       y = expression("Verb Production Difficulty " (~italic(d)[v])),
       caption = "N Children = 5899; N Verbs = 47") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman"))
```

## Regress b on `embod`

```{r}
mod_embod <- lm(b ~ embod_z, data = verbs_items)
```

```{r}
star_mod <- stargazer(
  mod_embod,
  type = "html",
  column.labels = "Model 1",
  title = "Linear Regression Predicting Production Difficulty (<i>d</i>) by Verb Embodiment (Z)",
  digits = 2,
  single.row = TRUE,
  covariate.labels = c("Verb Embodiment (Z)"),
  dep.var.caption = "",
  dep.var.labels = ""
)

cat(star_mod, sep = "\n", file = "mytable.html")
```


### Table of `mod_embod`

```{r}
regression_table <- tidy(mod_embod, conf.int = TRUE) %>%
  mutate(
    estimate = round(estimate, 2),
    std.error = round(std.error, 2),
    statistic = round(statistic, 2),
    p.value = round(p.value, 3),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2)
  )

colnames(regression_table) <- c("Predictor", "Estimate", "SE", "t", "p")

regression_table$Predictor <- recode(regression_table$Predictor,
                                     `(Intercept)` = "Intercept",
                                     `embod_z` = "Embodiment (Z)")

regression_table %>% 
  kable(caption = "<span style='font-family: Times New Roman;'>Linear Regression Predicting Production Difficulty (d) from Embodiment</span>",
        align = "lcccc", digits = 2) %>%
  kable_styling(full_width = FALSE, font_size = 12) %>% 
  row_spec(0, extra_css = "font-family: Times New Roman;") %>%
  column_spec(1:5, extra_css = "font-family: Times New Roman;")
```

# Create `full` data frame

```{r}
full <- verbs_long_data %>% 
  left_join(by_child) %>% 
  left_join(verbs_items) %>% 
  na.omit()
```

# DIF

```{r}
full_wide <- full %>% 
  pivot_wider(
    id_cols = c(child_id, older, age_c, mean_verb_score),
    names_from = item_id,
    values_from = produces
  )

dif_402 <- glm(item_402 ~ mean_verb_score + older, full_wide, family = binomial)

summary(dif_402)
```


# Multilevel modeling

```{r}
m1 <- glmer(produces ~ embod_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m1)

m2 <- glmer(produces ~ embod_z + age_c + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m2)

m3 <- glmer(produces ~ embod_z + age_c + age_c*embod_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m3)

p <- ggeffect(m3, terms = c("embod_z", "age_c[0, 2, 4, 6, 8, 10, 12, 14]")) %>% 
  plot()

p + 
  scale_x_continuous(
    breaks = c(-2, -1, 0, 1, 2),
  ) +
  labs(
    title = "Predicted Probability of Verb Production by Age & Embodiment",
    x = "Embodiment Score",
    y = "Predicted Probability",
    color = "Age Group" # legend label if needed
  ) +
  scale_color_discrete(
    labels = c("16mo", "18mo", "20mo", "22mo", "24mo", "26mo", "28mo", "30mo")) +
  theme(text = element_text(family = "Avenir"), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12))



```

## Concreteness & imageability comparison

```{r}
m_concrete <- glmer(produces ~ concrete_z + age_c + log_freq_z + age_c*concrete_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

m_image <- glmer(produces ~ image_z + age_c + log_freq_z + age_c*image_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)
```

### Table comparison

```{r}
comp_sem <- stargazer(
  m_freq2, m_concrete, m_image, 
  column.labels = "Embodiment", "Concreteness", "Imageability",
  type = "html",
  title = "GLMER Models Predicting Verb Production from Semantic Variables",
  digits = 2,
  single.row = TRUE,
  covariate.labels = c("Embodiment (Z)", "Concreteness (Z)", "Imageability (Z)", "Age", "Age x Embodiment (Z)", "Age x Concreteness (Z)", "Age x Imageability (Z)"),
  dep.var.caption = "",
  dep.var.labels = "")

cat(comp_sem, sep = "\n", file = "mytablecomp.html")
```

### Cor Tests

```{r}
cor.test(verbs_items$embod_z, verbs_items$concrete_z, method = "pearson")

cor.test(verbs_items$embod_z, verbs_items$image_z)

cor.test(verbs_items$concrete_z, verbs_items$image_z)
```

### Concrete + embod model

```{r}
m_conc_embod <- glmer(produces ~ concrete_z + embod_z + age_c + log_freq_z + age_c*concrete_z + age_c*embod_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

m_conc_image <- glmer(produces ~ image_z + embod_z + age_c + log_freq_z + age_c*image_z + age_c*embod_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)
```

### Compare full models

```{r}
compare_models <- stargazer(
  m_freq2, m_concrete, m_image, m_conc_embod, m_conc_image,
  type = "html",
  title = "GLMER Models Predicting Verb Production",
  covariate.labels = c("Concreteness (Z)", "Imageability (Z)", "Embodiment (Z)", "Age", "Log Frequency (Z)", "Age x Concreteness (Z)", "Age x Imageability (Z)", "Age x Embodiment (Z)"),
  digits = 2,
  single.row = TRUE,
  dep.var.caption = "",
  dep.var.labels = "")

cat(compare_models, sep = "\n", file = "mytable_compare.html")

```

## Frequency

```{r}
freq <- read.csv('~/documents/research/norms/childes_freq.csv') %>% 
  mutate(log_freq = log(childes_freq))

freq$log_freq_z <- scale(freq$log_freq)

full <- full %>% 
  left_join(freq)

m_freq <- glmer(produces ~ embod_z + age_c + log_freq_z +
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

m_freq2 <- glmer(produces ~ embod_z + age_c + log_freq_z + age_c*embod_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)
```

### Plot

```{r}
x_m_freq2 <- ggeffect(m_freq2, terms = c("embod_z[-2,0,2]", "age_c[0, 2, 4, 6, 8, 10, 12, 14]", "log_freq_z[mean]")) %>%
  plot()
```

### Table frequency

```{r}
freq_ms <- stargazer(
  m1, m2, m_freq, m_freq2, 
  type = "html",
  title = "GLMER Models Predicting Verb Production",
  covariate.labels = c("Embodiment (Z)", "Age", "Log Frequency (Z)", "Age x Embodiment (Z)"),
  digits = 2,
  single.row = TRUE,
  dep.var.caption = "",
  dep.var.labels = "")

cat(freq_ms, sep = "\n", file = "mytablefreq_ms.html")
```

## Productive vocab size

```{r}
m4 <- glmer(produces ~ embod_z + prod_size + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m4)

m5 <- glmer(produces ~ embod_z + prod_size + embod_z*prod_size +
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m5)

m6 <- glmer(produces ~ embod_z + prod_size + age_c + embod_z*prod_size +
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m6)
```

## Child x embodiment random effects

```{r}
m7 <- glmer(produces ~ embod_z +
              (embod_z|child_id) + (1|item_id),
            data = full,
            family = binomial,
            nAGQ = 0)

m8 <- glmer(produces ~ embod_z*age_c +
              (embod_z|child_id) + (1|item_id),
            data = full,
            family = binomial,
            nAGQ = 0)

m7 %>% summary()
m8 %>% summary()

x <- ggeffect(m3, terms = c("age_c[0,4,8,12,14]", "embod_z[-2,0,2]")) %>%
  mutate(logit = qlogis(predicted))
```

```{r}
m9 <- glmer(produces ~ embod_z*(age_c + prod_size) +
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial,
            nAGQ = 0)
m3 %>% tidy()
m9 %>% tidy()

corr.test(full$age, full$prod_size)
```


## Visualize models

```{r}
glmer <- stargazer(
  m1, m2, m3, 
  column.labels = "Model 1", "Model 2", "Model 3",
  type = "html",
  title = "Generalized Linear Mixed Effects Regression Models Predicting Verb Production",
  digits = 2,
  single.row = TRUE,
  covariate.labels = c("Embodiment (Z)", "Age", "Age x Embodiment (Z)"),
  dep.var.caption = "",
  dep.var.labels = "")

cat(glmer, sep = "\n", file = "mytable2.html")
```

## Compare concrete & embod

The difference ($\Delta$AIC) is 10.7, which is generally considered strong evidence to favor the model with the lower AIC (m1).

Rule of thumb: Differences in AIC > 10 indicate essentially no support for the higher AIC model (Burnham & Anderson, 2002).

Burnham, K. P., & Anderson, D. R. (2002). Model Selection and Multimodel Inference: A Practical Information-Theoretic Approach.

```{r}
m0_a <- glmer(produces ~ concrete_z + 
              (1|child_id) + (1|item_id),
            data = full,
            family = binomial)

summary(m0_a)

AIC(m0_a, m1)

m0_b <- glmer(produces ~ embod_z + concrete_z + (1 | child_id) + (1 | item_id), data = full, family = binomial)

summary(m0_b)
```

### Prior linear model

```{r}

mod1 <- glm(produces ~ theta_2pl, data = full)

summary(mod1)

mod2 <- glm(produces ~ theta_2pl + age_c, data = full)

summary(mod2)

mod3 <- glm(produces ~ theta_2pl + age_c + embod_z, data = full)

summary(mod3)

mod4 <- glm(produces ~ theta_2pl + age_c + embod_z + age_c:embod_z, data = full)

summary(mod4)

anova(mod1, mod2, test = "Chisq")

anova(mod2, mod3, test = "Chisq")

anova(mod3, mod4, test = "Chisq")
```


# Create age groups

Split children into 16-20, 21-25, & 26-30

See if children at the same proficiency level differ in the embodiment or concreteness effects across age groups
